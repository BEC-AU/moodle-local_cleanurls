From 840010c44f6fc091ee3ce511ec1ac25e5aa807e9 Mon Sep 17 00:00:00 2001
From: Brendan Heywood <brendan@catalyst-au.net>
Date: Fri, 9 Oct 2015 11:13:30 +1100
Subject: [PATCH] MDL-28030 local_cleanurls: tiny patches enabling clean urls

See here for more details:
https://github.com/brendanheywood/moodle-local_cleanurls
---
 lib/outputrenderers.php |    2 ++
 lib/weblib.php          |   21 ++++++++++++++++++++-
 2 files changed, 22 insertions(+), 1 deletion(-)

diff --git a/lib/outputrenderers.php b/lib/outputrenderers.php
index 97abc70..1e6a9a7 100644
--- a/lib/outputrenderers.php
+++ b/lib/outputrenderers.php
@@ -480,6 +480,8 @@ class core_renderer extends renderer_base {
         // This is only set by the {@link redirect()} method
         $output .= $this->metarefreshtag;
 
+        include("$CFG->dirroot/local/cleanurls/head.php");
+
         // Check if a periodic refresh delay has been set and make sure we arn't
         // already meta refreshing
         if ($this->metarefreshtag=='' && $this->page->periodicrefreshdelay!==null) {
diff --git a/lib/weblib.php b/lib/weblib.php
index 81b075d..a84ffb9 100644
--- a/lib/weblib.php
+++ b/lib/weblib.php
@@ -543,6 +543,25 @@ class moodle_url {
     }
 
     /**
+     * Output clean urls.
+     *
+     * This is a proxy of the core method to rewrite urls into clean urls
+     *
+     * @param bool $escaped Use &amp; as params separator instead of plain &
+     * @param array $overrideparams params to add to the output url, these override existing ones with the same name.
+     * @return string Resulting URL
+     */
+    public function out($escaped = true, array $overrideparams = null) {
+        global $CFG;
+        require_once($CFG->dirroot.'/local/cleanurls/lib.php');
+        $murl = $this;
+        if (get_config('local_cleanurls', 'cleaningon')) {
+            $murl = clean_moodle_url::clean($murl);
+        }
+        return $murl->orig_out($escaped, $overrideparams);
+    }
+
+    /**
      * Output url.
      *
      * If you use the returned URL in HTML code, you want the escaped ampersands. If you use
@@ -552,7 +571,7 @@ class moodle_url {
      * @param array $overrideparams params to add to the output url, these override existing ones with the same name.
      * @return string Resulting URL
      */
-    public function out($escaped = true, array $overrideparams = null) {
+    public function orig_out($escaped = true, array $overrideparams = null) {
         if (!is_bool($escaped)) {
             debugging('Escape parameter must be of type boolean, '.gettype($escaped).' given instead.');
         }
-- 
1.7.9.5

